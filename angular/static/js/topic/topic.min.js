/*! et 2014-08-08 18:59:53 by @Julien */
function topic(a,b,c,d){function e(a,d,e,f){var g=a.tid=e.absUrl().split("topic/")[1];g=(g||"").split(/\W/).shift(),a.tid=g,a.init=function(b){b||a.getTopic(g)},a.getTopic=function(b){d({method:"GET",url:c.ajaxApi.topic,params:{tid:b}}).success(function(b){a.topic=b}).error(function(){})};a.up=function(b){return b.isDeclare?alert("同学，表白一次就够了."):void f.getUser().then(function(e){return e.id?void d({method:"put",url:c.ajaxApi.topicUp,data:{tid:b.id}}).success(function(){b.like+=1,b.isDeclare=!0}):a.toggleLoginBox()})},a.down=function(b){return b.isDeclare?alert("同学，表白一次就够了."):void f.getUser().then(function(e){return e.id?void d({method:"put",url:c.ajaxApi.topicDown,data:{tid:b.id}}).success(function(){b.dislike+=1,b.isDeclare=!0}):a.toggleLoginBox()})},a.share=function(){},a.replyf=function(b){f.getUser().then(function(e){return e.id?void d({method:"post",url:c.ajaxApi.topicReply,data:{tid:b.id,txt:b.replyText}}).success(function(c){b.replying=!1,b.reply_num=1*b.reply_num+1;var d={pub:c.pub,id:c.id,txt:b.replyText,user:e};a.$broadcast("newReply",d)}).error(function(b,c){return 0===(c+"").indexOf("403")?a.toggleLoginBox():void alert(b.msg)}):(alert("登录先"),a.toggleLoginBox())})},a.cancel=function(a){a.replying=!a.replying},a.getReplies=function(a){a.toggle=!a.toggle,1*a.reply_num>0&&(a.lookTip=a.lookTip?void 0:"收起回复",a.tmplName="replies.html")},a.editTopic=function(c){a.copyTopic=b.copy(c),c.editing=!c.editing,c.editTmpl="topicEdit.html"},a.editCancel=function(){a.topic.editing=!a.topic.editing,a.topic.editTmpl="",delete a.copyTopic},a.$on("edit.topic.success",function(){a.topic=a.copyTopic})}function f(a,b){var d=a.tid;a.init=function(b,c){a.tid=b&&b.id||d,c||a.getReplies(1)},a.getReplies=function(d){d=d||1,b({method:"GET",url:c.ajaxApi.topicReplies,params:{tid:a.tid,page:d}}).success(function(b){a.replies=b.data}).error(function(){})},a.$on("newReply",function(b,c){a.replies.unshift(c)})}function g(a,d,e,f){a.init=function(b){a.reply=b},a.up=function(b){return b.isDeclare?alert("同学，表白一次就够了."):void f.getUser().then(function(e){return e.id?void d({method:"put",url:c.ajaxApi.topicReplyUp,data:{rid:b.id}}).success(function(){b.like=(b.like||0)+1,b.isDeclare=!0}).error(function(a){alert(a.msg)}):a.toggleLoginBox()})},a.down=function(b){return b.isDeclare?alert("同学，表白一次就够了."):void f.getUser().then(function(e){return e.id?void d({method:"put",url:c.ajaxApi.topicReplyDown,data:{rid:b.id}}).success(function(){b.dislike=(b.dislike||0)+1,b.isDeclare=!0}).error(function(a){alert(a.msg)}):a.toggleLoginBox()})},a.share=function(){},a.replyf=function(b){f.getUser().then(function(e){return e.id?(a.cancel(b),void d({method:"post",url:c.ajaxApi.topicReplyComment,data:{rid:b.id,txt:b.replyText}}).success(function(c){b.comment_num=1*b.comment_num+1,a.getRcomments(b),a.$broadcast("newComment",{pub:c.pub,id:c.id,user:e,txt:b.replyText})}).error(function(a){alert(a.msg)})):a.toggleLoginBox()})},a.cancel=function(a){a.repling=!a.repling},a.getRcomments=function(a){a.toggle=!a.toggle,1*a.comment_num>0&&(a.lookTip=a.lookTip?void 0:"收起评论",a.tmplName="comments.html")},a.editReply=function(){a.copyReply=b.copy(a.reply),a.reply.editing=!a.reply.editing,a.reply.editTmpl="replyEdit.html"},a.editCancel=function(){a.reply.editing=!a.reply.editing,a.reply.editTmpl="",delete a.copyReply},a.$on("edit.reply.success",function(){a.reply=a.copyReply})}function h(a,b,d,e){a.init=function(b){a.rid=b.id,a.getComments()},a.getComments=function(d){d=d||1,b({method:"GET",url:c.ajaxApi.topicReplyComments,params:{rid:a.rid,page:d}}).success(function(b){a.comments=b.data}).error(function(){})},a.remove=function(d,f){b({method:"DELETE",url:c.ajaxApi.topicReplyComment,data:{cid:d.id}}).success(function(){a.comments.splice(f,1),e.alert("删除成功!")}).error(function(a){alert(a.msg)})},a.$on("newComment",function(b,c){a.comments.unshift(c)})}function i(a,b,d){a.init=function(b){a.comment=b},a.up=function(e){return e.isDeclare?alert("同学，表白一次就够了."):void d.getUser().then(function(d){return d.id?void b({method:"put",url:c.ajaxApi.topicReplyCommentUp,data:{cid:e.id}}).success(function(){e.like=(e.like||0)+1,e.isDeclare=!0}).error(function(a){alert(a.msg)}):a.toggleLoginBox()})},a.down=function(e){return e.isDeclare?alert("同学，表白一次就够了."):void d.getUser().then(function(d){return d.id?void b({method:"put",url:c.ajaxApi.topicReplyCommentDown,data:{cid:e.id}}).success(function(){e.dislike=(e.dislike||0)+1,e.isDeclare=!0}).error(function(a){alert(a.msg)}):a.toggleLoginBox()})},a.share=function(){},a.replyf=function(e){d.getUser().then(function(d){return d.id?(a.cancel(e),void b({method:"post",url:c.ajaxApi.topicReplyComment,data:{cid:e.id,txt:e.replyText}}).success(function(b){var c={pub:b.pub,id:b.id,txt:e.replyText,user:d,puser:{nicknm:e.user.nicknm}};a.comments.push(c)}).error(function(a){alert(JSON.stringify(a))})):a.toggleLoginBox()})},a.cancel=function(a){a.replying=!a.replying},a.editReply=function(a){a.editing=!a.editing,a.editTmpl="commentEdit.html"},a.editcancel=function(a){a.editing=!a.editing,a.editTmpl=""},a.editSubmit=function(d){b({method:"put",url:c.ajaxApi.topicReplyComment,data:{rid:reply.id,txt:reply.txt}}).success(function(){a.editCancel(d)}).error(function(a){alert(a.msg)})}}function j(a,b,c,d,e){a.init=function(b){a.topic=b},a.submit=function(){e.edit(a.topic).then(function(){a.$emit("edit.topic.success",{})},function(a){alert(a.data.msg)})}}function k(a,b,d,e,f){a.init=function(b){a.reply=b},a.submit=function(){var d=a.reply;b({method:"put",url:c.ajaxApi.topicReplyEdit,data:{rid:d.id,txt:d.txt}}).success(function(){f.alert("修改成功"),a.$emit("edit.reply.success",{})}).error(function(a){alert(a.msg)})}}function l(a,b){a.init=function(b){a.comment=b},a.submit=function(){a.comment;b({method:"put",url:c.ajaxApi.topicReplyComment,data:{rid:reply.id,txt:reply.txt}}).success(function(){a.$emit("edit.comment.success",{})}).error(function(a){alert(a.msg)})}}var m=d||b.module("etApp",["etServices","etDirectives","etFilters","etAnimations","etControllers"]);return m.controller("topicCtrl",["$scope","$http","$location","userManager","topicManager","prompt",e]),m.controller("replyCtrl",["$scope","$http","$location","userManager","prompt",g]),m.controller("repliesCtrl",["$scope","$http","$location","userManager",f]),m.controller("commentsCtrl",["$scope","$http","userManager","prompt",h]),m.controller("commentCtrl",["$scope","$http","userManager",i]),m.controller("editTopicCtrl",["$scope","$http","$location","userManager","topicManager","prompt",j]),m.controller("editReplyCtrl",["$scope","$http","$location","userManager","prompt",k]),m.controller("editCommentCtrl",["$scope","$http","userManager","prompt",l]),m.controller("topicRelCtrl",["$scope","$location","topicManager",function(a,b,c){var d=a.tid=b.absUrl().split("topic/")[1];d=(d||"").split(/\W/).shift(),c.getTopicRel(d).then(function(b){a.topicRel=b})}]),m}