/*! et 2014-08-11 16:00:09 by @Julien */
function etApp($,angular,etConfig,_etapp){function enjoyerShowCtrl(a,b,c,d){function e(){b({method:"GET",url:etConfig.ajaxApi.enjoyerShow}).then(function(b){angular.forEach(b.data,function(a){this.push(a)},a.profits),d(function(){a.bg="yellow"},200)},function(){})}a.profits=[],e()}function loginCtrl(a,b){a.user={},a.submit=function(){b({method:"post",url:etConfig.ajaxApi.login,data:a.user}).success(function(){a.$emit("loginOk",{})}).error(function(b){a.msg=b.msg})}}function mainCtrl(a,b,c,d){function e(){b.get(etConfig.ajaxApi.notify).then(function(b){a.msgNum=b.data.num},function(){})}function f(){d.getUser().then(function(b){a.user=b,b.id&&e()})}a.logout=function(){d.logout().then(function(){},function(){}),a.user={}},a.toggleLoginBox=function(){a.showMenu=!1,a.showReg=!1,a.showNewTopic=!1,a.alert=a.showLogin=!a.showLogin},a.toggleRegBox=function(){a.showMenu=!1,a.showLogin=!1,a.showNewTopic=!1,a.alert=a.showReg=!a.showReg},a.toggleNewTopicBox=function(){d.getUser().then(function(b){return b.id?(a.showMenu=!1,a.showLogin=!1,a.showReg=!1,void((a.alert=a.showNewTopic=!a.showNewTopic)||a.$broadcast("closeNewTopic",{}))):a.toggleLoginBox()},function(){a.toggleLoginBox()})},a.toggleMenuBox=function(){a.showLogin=!1,a.showReg=!1,a.showNewTopic=!1,a.showMenu=!a.showMenu},a.$on("topic:edit:end",function(b,c){a.$broadcast("topic:edit:end:broadcast",c)}),a.$on("loginOk",function(){a.alert=a.showLogin=!1,f(),a.$broadcast("logined",{})}),a.$on("regOk",function(){a.alert=a.showReg=!1,f()}),f()}function newTopicCtrl(a,b,c){a.topic={},a.msg="",b.get(etConfig.ajaxApi.cats).success(function(b){a.cats=b}),a.selectTopicType=function(b){a.topic.type=b},a.submit=function(){b({method:"post",url:etConfig.ajaxApi.topic,data:a.topic}).success(function(){a.msg="ok",a.topic={},a.toggleNewTopicBox(),c.alert("微话题发表成功!")}).error(function(a){alert(a.msg)})},a.$on("closeNewTopic",function(){a.topic={}})}function notifyCtrl(a,b,c){b.get(c.ajaxApi.notify+"?list=true").then(function(b){a.msgNum=b.data.num,a.list=b.data.list},function(a){alert("error:"+typeof a.data=="object"?a.data.msg:a.data)})}function phasesTagCtrl(a,b){a.init=function(b){a.catId=b},b.getCatList().then(function(b){var c=function(a,b){var c,d,e="object"==typeof a?a.id:a,f=function g(a){c=a;for(var b,f=0;f<a.length;f++)if(d=f,b=a[f],b.id==e)return 1;for(f=0;f<a.length;f++)if(b=a[f],b.son&&g(b.son))return 1}(b);return f?{place:c,index:d}:{place:[]}},d=c(a.catId,b),e=d.place[d.index],f=e?1*e.parent_id:null;if(null!==f){a.pid=f||a.catId;for(var g in b)b[g].id===1*a.pid&&(a.children=b[g].son);a.phases=b}},function(){})}function regCtrl(a,b,c){var d=b.search(),e=a.user={};d.invite&&(e.invite=d.invite),a.uploadConf={url:etConfig.ajaxApi.uploadPortrait,success:function(b){a.$apply(function(){a.user.portrait_id=b.portrait_id,a.previewSrc=b.portrait})},error:function(a){alert(a)}},a.submit=function(){c({method:"post",url:etConfig.ajaxApi.register,data:a.user}).success(function(){a.stat="ok",a.$emit("regOk",{})}).error(function(b){a.stat="error",a.msg=b.msg})}}function topTopicCtrl(a,b){a.top=[],b({method:"GET",url:etConfig.ajaxApi.topTopic}).success(function(b){a.top=b}).error(function(){})}function _etConfig(){return{ajaxApi:{user:"/api/user/me",userDetail:"/api/user/info/detail",userMeDetail:"/api/user/me/detail",userIncome:"/api/user/income",notify:"/api/user/notif",userWorkEx:"/api/user/companies",userEduEx:"/api/user/schools",follow:"/api/user/follow",followNum:"/api/user/follow/nums",follows:"/api/user/follow/users",login:"/api/user/login",logout:"/api/user/logout",register:"/api/user/register",suggest:"/api/user/suggest",uploadPortrait:"/api/user/portrait/upload",catsOverview:"/api/cat/overview",catList:"/api/cat/list",cats:"/api/cats",topics:"/api/topics",topic:"/api/topic",topicUp:"/api/topic/up",topicDown:"/api/topic/down",topicRel:"/api/topic/related",topicReplyUp:"/api/topic/reply/up",topicReplyDown:"/api/topic/reply/down",topicReplyCommentUp:"/api/topic/reply/comment/up",topicReplyCommentDown:"/api/topic/reply/comment/down",topicReplies:"/api/topic/replies",topicReply:"/api/topic/reply",topicReplyEdit:"/api/topic/reply",topicReplyComments:"/api/topic/reply/comments",topicReplyComment:"/api/topic/reply/comment",editorUpload:"/editor/php/upload_json.php",enjoyerShow:"/api/user/enjoyer/topshow"}}}function followManager(a,b){return{follow:function(c){return a({method:"put",url:b.ajaxApi.follow,params:{uid:c}})},getFollowNum:function(c){return a({method:"get",url:b.ajaxApi.followNum,params:{uid:c}})},getFollow:function(c){return a({method:"get",url:b.ajaxApi.follows,params:c})}}}function prompt(){var a;return{alert:function(b){a=a||$('<div class="prompt">@@@@@</div>').appendTo($("body")),a.html('<div class="wrap">'+b+"</div>"),a.slideDown(500).delay(2e3).slideUp(500)}}}function topicManager(a,b,c){return{getCatList:function(){return c.get(etConfig.ajaxApi.catList).then(function(a){return a.data},function(a){return a})},getTopic:function(){c({method:"GET",url:etConfig.ajaxApi.topic,params:{tid:tid}}).success(function(a){$scope.topic=a}).error(function(){})},create:function(){},edit:function(a){return c.put(etConfig.ajaxApi.topic,{cat:a.cat,type:a.type,tid:a.id,tit:a.tit,txt:a.txt}).then(function(a){return a},function(){return response})},getTopicRel:function(a){return c({method:"GET",url:etConfig.ajaxApi.topicRel,params:{tid:a}}).then(function(a){return a.data},function(a){return a})}}}function userManager(a,b,c){var d={};return{getUser:function(){if(d.id){var a=b.defer();return a.resolve(d),a.promise}return c.get(etConfig.ajaxApi.user).then(function(a){return d=a.data},function(a){return a})},getUserDetail:function(a,b){var d=b?"userMeDetail":"userDetail",e=a?{uid:a}:{};return d=a?"userDetail":"userMeDetail",c({method:"get",url:etConfig.ajaxApi[d],params:e}).then(function(a){return a.data},function(a){return a})},logout:function(){return d.id?c.put(etConfig.ajaxApi.logout).then(function(a){return d={},a},function(a){return a}):void 0},addWorkEx:function(a){return c.post(etConfig.ajaxApi.userWorkEx,a).then(function(a){return a},function(a){return a})},addEduEx:function(a){return c.post(etConfig.ajaxApi.userEduEx,a).then(function(a){return a},function(a){return a})},edit:function(a){return c.put(etConfig.ajaxApi.user,a).then(function(a){return a.data},function(a){return a.data})},getIncome:function(){return c.get(etConfig.ajaxApi.userIncome).then(function(a){return a.data},function(a){alert(a.data.msg)})},getTopics:function(a){return c.get(etConfig.ajaxApi.userTopics+"?page="+(a||1)).then(function(a){return a.data},function(a){alert(a.data.msg)})},getReplies:function(a){return c.get(etConfig.ajaxApi.userReplies+"?page="+(a||1)).then(function(a){return a.data},function(a){alert(a.data.msg)})}}}function dateFormat(){return function(a,b){var c=new Date,d=a+"";d=13===d.length,c.setTime(d?a:1e3*a);var e={"M+":c.getMonth()+1,"d+":c.getDate(),"h+":c.getHours(),"m+":c.getMinutes(),"s+":c.getSeconds(),"q+":Math.floor((c.getMonth()+3)/3),"S+":c.getMilliseconds()};/(y+)/i.test(b)&&(b=b.replace(RegExp.$1,(c.getFullYear()+"").substr(4-RegExp.$1.length)));for(var f in e)new RegExp("("+f+")").test(b)&&(b=b.replace(RegExp.$1,1==RegExp.$1.length?e[f]:("00"+e[f]).substr((""+e[f]).length)));return b}}function prefix(){return function(a,b){return b=b||"",a?b+a:void 0}}function userIcon(){return function(a){return"/assets/vcn/img/user/type-"+a+".png"}}function enterPress(){return{restrict:"A",scope:{enterPress:"=etEnterPress"},link:function(a,b){var c=function(b){13==b.which&&a.enterPress()};b.focus(function(){b.keypress(c)}),b.blur(function(){b.unbind("keypress",c)})}}}function reditor(){return{restrict:"A",scope:{reditor:"=reditor"},link:function(a,b){var c={language:"zh_cn",contentChangedCallback:function(){var b=d.editable("getHTML")[0];"<p><br></p>"===b&&(b=""),d.val(b),d.trigger("change"),a.$apply(function(){})},autosave:!0,autosaveInterval:100,saveURL:null,blockTags:["n","p","blockquote","pre","h4","h5","h6"],borderColor:"",buttons:["bold","italic","underline","strikeThrough","fontSize","color","sep","formatBlock","align","insertOrderedList","insertUnorderedList","outdent","indent","sep","selectAll","createLink","insertImage","undo","redo"],crossDomain:!1,direction:"ltr",editorClass:"",height:"auto",imageMargin:20,imageErrorCallback:function(){console.log(JSON.stringify(arguments))},imageUploadParam:"imgFile",imageUploadURL:"/editor/php/upload_json.php",inlineMode:!1,placeholder:" ",shortcuts:!0,spellcheck:!1,typingTimer:12250,minHeight:120,width:"auto"},d=jQuery(b[0]),e={},f=$.extend({},c,e.conf||{});d.editable(f),d.editable("setHTML",d.val()||a.reditor||"<p><br></p>",!1)}}}function returnTop(){return{restrict:"A",link:function(){var a=jQuery,b=a(window),c=b.height()/2,d=a(document.body),e='<div class="pure-button pure-button-primary returnTop">top</div>',f=a(e).appendTo(a("body")).click(function(){d.animate({scrollTop:0},240)}),g=function(){var a=d.scrollTop();a>c?f.fadeIn():f.fadeOut()},h=_.throttle(g,200);b.on("scroll",h)}}}function roll(){return{restrict:"A",scope:{roll:"=roll"},link:function(a,b){function c(){var a=b.children(":first"),c=a.next();c.length&&(a.css("height",e),c.css("height",e),d(b).animate({top:"-"+e},500,function(){a.appendTo(b),b.css({top:0})}))}var d=jQuery,e=b.parent().height()+"px";setInterval(c,2800)}}}function scratchCard($http){return{restrict:"A",scope:{},link:function(scope,elm,attrs){elm.html('<canvas id="scratch-card"></canvas>');var offset,eventDown,eventUp,eventMove,img=new Image,w=200,h=50,done=!1,canvas=document.getElementById("scratch-card");canvas.parentNode.parentNode.style.mozUserSelect="none",canvas.parentNode.parentNode.style.webkitUserSelect="none",canvas.style.backgroundColor="transparent",canvas.style.position="absolute",img.addEventListener("load",function(e){function layer(a){a.fillStyle="gray",a.fillRect(0,0,w,h)}var ctx,mousedown=!1;eventDown=function(a){a.preventDefault(),mousedown=!0,offset=elm.offset()},eventUp=function(a){a.preventDefault(),mousedown=!1;for(var b=ctx.getImageData(20,0,w-40,h).data,c=0,d=0;c<b.length;c+=4)b[c]&&b[c+1]&&b[c+2]&&b[c+3]&&++d;!done&&(w-40)*h*.6>=d&&$http({method:"post",url:etConfig.ajaxApi.scratchCardPrize}).success(function(a){1==a.stat?(canvas.removeEventListener("touchstart",eventDown,!1),canvas.removeEventListener("touchend",eventUp,!1),canvas.removeEventListener("touchmove",eventMove,!1),canvas.removeEventListener("mousedown",eventDown,!1),canvas.removeEventListener("mouseup",eventUp,!1),canvas.removeEventListener("mousemove",eventMove,!1),img.src=etConfig.ajaxApi.scratchCardImage+"?t="+Math.random(),alert(a.msg)):(done=!0,alert(a.msg))}).error(function(a,b){401==b&&(done=!0)})},eventMove=function(e){if(e.preventDefault(),mousedown)with(e.layerX&&(e.offsetX=e.layerX,e.offsetY=e.layerY),e.changedTouches&&(e=e.changedTouches[e.changedTouches.length-1],e.offsetX=e.pageX-offset.left,e.offsetY=e.layerY?e.layerY:e.pageY-offset.top),ctx)beginPath(),arc(e.offsetX,e.offsetY,10,0,2*Math.PI),fill()},canvas.width=w,canvas.height=h,canvas.style.backgroundImage="url("+img.src+")",ctx=canvas.getContext("2d"),ctx.fillStyle="transparent",ctx.fillRect(0,0,w,h),layer(ctx),ctx.globalCompositeOperation="destination-out",canvas.addEventListener("touchstart",eventDown,!1),canvas.addEventListener("touchend",eventUp,!1),canvas.addEventListener("touchmove",eventMove,!1),canvas.addEventListener("mousedown",eventDown,!1),canvas.addEventListener("mouseup",eventUp,!1),canvas.addEventListener("mousemove",eventMove,!1)}),img.src=etConfig.ajaxApi.scratchCardImage+"?t="+Math.random()}}}function upload(){return{restrict:"A",scope:{upload:"=etUpload"},link:function(a,b){b.change(function(){var c=new FormData;$.each(b[0].files,function(a,b){c.append("headphoto",b)}),console.log(c),$.ajax({url:a.upload.url,type:"POST",data:c,cache:!1,contentType:!1,processData:!1,success:function(b){var c=a.upload.success;c&&c(b)},error:function(a){alert(a.msg)}})})}}}$(function(){setTimeout(function(){var a=$("#top").height()+$("footer").height();a=$(document).height()-a+20,$("#main").css({"min-height":a+"px"}),$("footer").css("visibility","visible")},1e3)});var etApp=_etapp||angular.module("etApp",["ngRoute","ngSanitize","etServices","etDirectives","etFilters","etAnimations","etControllers"]),etServices=angular.module("etServices",[]);etServices.factory("etConfig",["$rootScope",_etConfig]),etServices.factory("prompt",["$rootScope",prompt]),etServices.factory("userManager",["$rootScope","$q","$http",userManager]),etServices.factory("topicManager",["$rootScope","$q","$http",topicManager]),etServices.factory("followManager",["$http","etConfig",followManager]);var etControllers=angular.module("etControllers",[]);etControllers.controller("mainCtrl",["$scope","$http","$location","userManager","topicManager",mainCtrl]),etControllers.controller("loginCtrl",["$scope","$http",loginCtrl]),etControllers.controller("regCtrl",["$scope","$location","$http",regCtrl]),etControllers.controller("newTopicCtrl",["$scope","$http","prompt",newTopicCtrl]),etControllers.controller("enjoyerShowCtrl",["$scope","$http","$interval","$timeout",enjoyerShowCtrl]),etControllers.controller("phasesTagCtrl",["$scope","topicManager",phasesTagCtrl]),etControllers.controller("notifyCtrl",["$scope","$http","etConfig",notifyCtrl]),etControllers.controller("topTopicCtrl",["$scope","$http",topTopicCtrl]);var etDirectives=angular.module("etDirectives",[]);etDirectives.directive("etUpload",["$http",upload]),etDirectives.directive("etEnterPress",enterPress),etDirectives.directive("returnTop",["$compile",returnTop]),etDirectives.directive("reditor",[reditor]),etDirectives.directive("roll",[roll]),etDirectives.directive("scratchCard",["$http",scratchCard]);var etFilters=angular.module("etFilters",[]);etFilters.filter("dateFormat",dateFormat),etFilters.filter("prefix",prefix),etFilters.filter("userIcon",userIcon),etFilters.filter("unsafe",["$sce",function(a){return function(b){return a.trustAsHtml(b)}}]);angular.module("etAnimations",["ngAnimate"]);return etApp}